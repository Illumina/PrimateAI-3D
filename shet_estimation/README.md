OVERVIEW

The inference of selection coefficients of all possible coding variants relies on both deep learning predicted pathogenicity (e.g., PrimateAI-3D) and forward time population simulation. The forward-time simulations of human population growth is conducted in order to estimate the expected depletion of rare variants for specific selection coefficients. 

Simulation under neutral evolution
First, fit models under the assumption of neutral evolution. The evolutionary history of human population is simplified into four stages of exponential expansion, each characterized by distinct growth rates, assuming an initial effective population size of 10,000 (see Documentation for details). A more complex model is also considered, evenly partitioning the human population into five subpopulations representing African, European, American, South Asian, and East Asian continental populations at the end of the initial exponential expansion phase. For the subsequent three stages of exponential expansion, these five subpopulations evolved independently without any migration. 

The simulation is initialized for 100K independent genomic sites assuming all chromosomes fixed for the ancestral allele. In each generation, the population size is expanded according to the specified growth rate, and chromosomes are randomly sampled from the previous generation. De novo mutations are randomly placed onto these chromosomes according to the de novo mutation rates derived from three large-scale whole genome sequencing studies of parental-offspring trios.

The three major classes of mutations are simulated separately due to different mutation rates: transition mutation at CpG sites (CpGTi), transition mutation at non-CpG sites (nonCpGTi) and transversion mutations (Tv). For CpGTi, separately simulated sites with high and low methylation levels, recognizing the impact of CpG methylation on mutation rates. 

For each set of simulation parameters, a human population is simulated from the early humans to the present day. Then randomly sample 1,000 sets of 246K chromosomes, equivalent to the sample size of gnomAD exomes. This simulation process can be iterated multiple times, and the simulated allele frequency spectrum (AFS) is generated by averaging across the 10,000 sampled sets from replications. Those unknown parameters in the demographic model are determined by optimizing the likelihood ratio comparing the simulated AFS spectrum with gnomAD synonymous AFS.

Simulation with selection effects
With optimal population historical parameters, selection coefficients are incorporated to the simulations across 36 selection coefficients, denoted as s, in [0, 0.0001, 0.0002, …,0.8, 0.9]. In each generation, after sampling chromosomes, mutations are randomly purged according to their selection coefficient. Subsequently de novo mutations are randomly sprinkled onto chromosomes. For each of the 36 selection coefficients and the de novo mutation rate for each of 192 of tri-nucleotide contexts, randomly sampled 1000 sets, each consisting of 500k genomes, mirroring the sample size of gnomAD, TOPMed, and UK Biobank 200K. Then aggregate those AFSs across the 192 de novo mutation rates for each selection coefficient.

As the selective pressure against mutations rises, it is expected that variants will be progressively more depleted in comparison to neutral variants. Using the simulated AFS under varying levels of selection, defined a metric “depletion” to quantify the proportion of variants eliminated by purifying selection relative to the scenario under neutral evolution (without selection).

The depletion values are generated for each of the 36 selection coefficients to establish a selection-depletion curve, on which curve fitting and interpolation enables us to estimate the selection coefficient for any given depletion value.


SYSTEM REQUIREMENTS

Hardware requirements

shet estimation requires only a standard computer with enough RAM to support the in-memory operations defined by a user.
For minimal performance, this will be a computer with about 2 GB of RAM. 
For optimal performance, we recommend a computer with the following specs:

RAM: 16+ GB
CPU: 4+ cores, 3.3+ GHz/core

The runtimes below are generated using a computer with the recommended specs (16 GB RAM, 4 cores@3.3 GHz) and internet of speed 25 Mbps.
Software requirements

OS Requirements

This package is supported for macOS and Linux. The package has been tested on the following systems:

macOS: Mojave (10.14.1)
Linux: Ubuntu 16.04
Python Dependencies

PrimateAI-3D based s_het estimation scripts are developed under Python 3.10.11 and mainly depends on the Python scientific stack.

numpy
scipy
scikit-learn
pandas

Please install these versions to execute the scripts.

For inference section, please install R version 3.4 or above.

the latest version of R can be installed by adding the latest repository to apt:

sudo echo "deb http://cran.rstudio.com/bin/linux/ubuntu xenial/" | sudo tee -a /etc/apt/sources.list
gpg --keyserver keyserver.ubuntu.com --recv-key E084DAB9
gpg -a --export E084DAB9 | sudo apt-key add -
sudo apt-get update
sudo apt-get install r-base r-base-dev

which should install in about 20 seconds.


INSTALLATION GUIDE

Install from Github

git clone https://github.com/Illumina/PrimateAI-3D/shet_estimation
cd shet_estimation
python3 simulation/simulation.py

which will install in about 30 seconds on a machine with the recommended specs.

USAGE
The command to run the script for forward time population simulation under neutral evolution is :

python  /path/to/source/simulation/simulation_SFS_neutral.py \
     [popratio] [snptype] [Nefactor] [T1] [T2] [nreps] [outdir]

The input paramters are explained below.
popratio: ratio between effective population size and the census population size, its optimal value is 30
snptype: SNP type, take in values 'nonCpGTi', 'CpGTi', 'Tv', 'CpGTi_MethyHigh',and 'CpGTi_MethyLow' 
Nefactor: the ratio Ne1/Ne0, its optimal value is 2.0. Ne0 is 10,000, initial effective population size. Ne1 is effective population size after the burn-in period
T1: Number of generations during the burn-in period, its optimal value is 3500
T2: Number of generations during the first expension period after burn-in, its optimal value is 530
nreps: Number of output samples sampled from the simulated final population at present day. Note these samples have a sample size resembling gnomAD exome sample size, 123K
outdir: output directory

simulation_SFS_neutral_splitting5populations.py has the same input paramaters listed above.

The command to run the script for forward time population simulation under selection is :     

python  /path/to/source/simulation/simulation_SFS_with_selection.py \
     [selection] [snptype] [mutrate] [nreps] [samplesize] [outdir]

The input paramters are explained below.

selection: selection coefficients used in the simulation
snptype: one of the 192 tri-nucleotide contexts
mutrate: mutation rates for one of the 192 tri-nucleotide contexts
nreps: Number of output samples sampled from the simulated final population at present day. Note these samples have a sample size resembling gnomAD exome sample size, 123K
samplesize: Number of individuals in each sample sampled from the simulated final population at present day, e.g., 500K corresponds to samplesize=1000000 
outdir: output directory

Note that mutation rates for the 192 tri-nucleotide contexts and methylation levels are in MutationRates folder.

In the inference folder, we provide R scripts for summarizing allele frequency spectrum,  inference of selection coefficients, and plotting selection-depletion curve.

DEMO DATA
Examples of output files from forward time population simulation are in data folder.
Each row of output files from simulation_SFS_neutral.py or simulation_SFS_neutral_splitting5populations.py contains the following columns, delimited by space:

The 1st column shows the value of T1.
The 2nd column shows the value of Nefactor.
The 3rd column shows the value of popratio.
The 4th column indicates snptype.
The 5th column indicates the index of output samples sampled from the simulated final population at present day.
The 6th column indicates the index of locus among the 100,000 independent loci where a variant occurs.
The 7th column indicates the allele count of the variant at the locus.

Each row of output files from simulation_SFS_with_selection.py contains the following columns, delimited by space:

The 1st column shows the value of selection coefficient.
The 2nd column indicates snptype.
The 3rd column indicates the index of output samples sampled from the simulated final population at present day.
The 4th column indicates the index of locus among the 100,000 independent loci where a variant occurs.
The 5th column indicates the allele count of the variant at the locus.
The 6th column indicates the generation when the variant occurs.

The example of a simulated allele frequency spectrum is shown below.


LICENSE

Copyright (c) 2024 Illumina, Inc. All rights reserved.

This software is provided under the terms and conditions of the GNU GENERAL PUBLIC LICENSE Version 3.

You should have received a copy of the GNU GENERAL PUBLIC LICENSE Version 3 along with this program. If not, see https://github.com/illumina/licenses/.

PrimateAI3D-based s_het estimation source code is provided under the GNU General Public license v3.0 (GPLv3) license. 
The s_het estimation source code includes several third party packages provided under other open source licenses, please see COPYRIGHT.txt for additional details. 

PrimateAI-3D predicted s_het scores are available with a non-commercial license upon request and other use requires a commercial license from Illumina, Inc.

The s_het scores are also displayed on https://primad.basespace.illumina.com.


CITATION

For usage of the package and associated manuscript, please cite according to the enclosed citation.bib.

CONTACT
If you have any questions, please send an email to hgao@illumina.com.
